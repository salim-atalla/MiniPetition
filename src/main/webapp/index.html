<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Petition App</title>
        <style>
            #app {
                width: 75%;
                margin: 50px auto;
            }
            #app > div > h1 {
                font-size: 30px;
                font-weight: bold;
                margin: 20px auto;
            }
            #app > div > div {
                margin: 35px auto;
            }
            #app > div > div:nth-child(3) > form > button {
                margin-top: 15px;
            }
            #app > div > div:nth-child(3) > form {
                display: flex;
                flex-direction: column;
                gap: 7px;
                margin-top: 33px;
            }
            /* Add your styles here if needed */
        </style>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"
        />
        <script
            defer
            src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"
        ></script>

        <script src="https://unpkg.com/mithril/mithril.js"></script>

        <script src="https://unpkg.com/jwt-decode@3.1.2/build/jwt-decode.js"></script>
        <script
            src="https://accounts.google.com/gsi/client"
            async
            defer
        ></script>
    </head>
    <body>
        <div id="app"></div>

        <script>
            const PetitionList = {
                petitions: [],

                loadPetitions: function () {
                    // Fetch the list of petitions from the backend
                    m.request({
                        method: "GET",
                        url: "_ah/api/petitionApi/v1/petitions/",
                    })
                        .then((response) => {
                            PetitionList.petitions = response;
                            m.redraw(); // Trigger a redraw to update the view
                        })
                        .catch((error) => {
                            console.error(
                                "Error fetching petition data:",
                                error
                            );
                        });
                },

                oninit: function (vnode) {
                    // Load petitions on component initialization
                    PetitionList.loadPetitions();
                },

                view: function (vnode) {
                    return m("div", [
                        m("h1", "Petition List"),
                        m(
                            "ul",
                            PetitionList.petitions.map((petition) =>
                                m("li", { key: petition.id }, [
                                    m("h3", petition.title),
                                    m("p", petition.content),
                                    m(
                                        "p",
                                        "Signatures: " +
                                            petition.signatures.length
                                    ),
                                ])
                            )
                        ),
                    ]);
                },
            };

            const PetitionForm = {
                title: "",
                content: "",

                createPetition: function () {
                    // Create a new petition and reload the list
                    m.request({
                        method: "POST",
                        url: "_ah/api/petitionApi/v1/createPetition/",
                        data: {
                            title: PetitionForm.title,
                            content: PetitionForm.content,
                        },
                    })
                        .then((response) => {
                            console.log("Petition created:", response);
                            PetitionList.loadPetitions(); // Reload the petition list
                        })
                        .catch((error) => {
                            console.error("Error creating petition:", error);
                        });
                },

                view: function (vnode) {
                    return m("div", [
                        m("h1", "Create Petition"),
                        m(
                            "form",
                            {
                                onsubmit: function (event) {
                                    event.preventDefault();
                                    PetitionForm.createPetition();
                                },
                            },
                            [
                                m("label.label", "Title"),
                                m("input.input[type=text]", {
                                    value: PetitionForm.title,
                                    oninput: function (e) {
                                        PetitionForm.title = e.target.value;
                                    },
                                    required: true,
                                }),

                                m("label.label", "Content"),
                                m("textarea.textarea", {
                                    value: PetitionForm.content,
                                    oninput: function (e) {
                                        PetitionForm.content = e.target.value;
                                    },
                                    required: true,
                                }),

                                m(
                                    "button.button.is-primary[type=submit]",
                                    "Create Petition"
                                ),
                            ]
                        ),
                    ]);
                },
            };

            const Home = {
                oninit: function (vnode) {
                    PetitionList.loadPetitions(); // Load petitions on the home page
                },

                view: function (vnode) {
                    return m("div", [
                        m("h1", "Home Page"),
                        m(PetitionList),
                        m(PetitionForm),
                    ]);
                },
            };

            // Define Mithril routes and components
            m.route(document.getElementById("app"), "/", {
                "/": Home,
            });
        </script>
    </body>
</html>
